<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laurier Navigator</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<script>
(() => {
  const BACKEND_BASE = "https://cp317-group-18-project.onrender.com";
  
  let btnGetRoute = null;
  let btnUseLocation = null;
  let btnCreateRoom = null;
  let startInput = null;
  let destInput = null;
  let routeInfo = null;
  let navLinks = null;
  let map = window.map || null;
  let currentRouteLayer = null;
  let currentRouteData = null;

  function ensureMap() {
    if (map) return map;
    if (typeof L === 'undefined') {
      console.warn('Leaflet not loaded; map features disabled.');
      return null;
    }
    map = L.map('map').setView([43.4723, -80.5449], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    window.map = map;
    return map;
  }

  function showRouteInfo(text) {
    if (routeInfo) routeInfo.innerHTML = `<p>${text}</p>`;
  }

  function clearRouteOnMap() {
    if (currentRouteLayer && map) {
      try { map.removeLayer(currentRouteLayer); } catch(e) {}
      currentRouteLayer = null;
    }
  }

  async function plotRouteOnMap(geometry) {
    const m = ensureMap();
    if (!m) return;
    clearRouteOnMap();
    currentRouteLayer = L.polyline(geometry, { weight: 4 });
    currentRouteLayer.addTo(m);
    try {
      m.fitBounds(currentRouteLayer.getBounds(), { padding: [30,30] });
    } catch (e) {}
  }

  async function getRoute() {
    const start = (startInput && startInput.value ? startInput.value.trim() : "");
    const dest = (destInput && destInput.value ? destInput.value.trim() : "");
    if (!start) { showRouteInfo('Please enter a start address.'); return; }
    if (!dest)  { showRouteInfo('Please enter a destination.'); return; }

    showRouteInfo('Loading route...');
    if (btnGetRoute) btnGetRoute.disabled = true;

    try {
      const url = `${BACKEND_BASE}/api/navigation/route?start=${encodeURIComponent(start)}&destination=${encodeURIComponent(dest)}&mode=walking`;
      const res = await fetch(url, { method: 'GET' });
      if (!res.ok) {
        const body = await res.text().catch(()=>res.statusText);
        showRouteInfo(`Route error: ${res.status} ${body}`);
        return;
      }
      const data = await res.json();
      if (!data.success) {
        showRouteInfo('Route failed: ' + (data.error || 'unknown'));
        return;
      }
      const route = data.route;
      // save route for "Create Room"
      currentRouteData = {
        start_text: start,
        dest_text: dest,
        start_coord: data.start_coord || null,
        dest_coord: data.dest_coord || null,
        distance_m: route.distance_m,
        duration_s: route.duration_s,
        geometry: route.geometry
      };

      const km = (route.distance_m / 1000).toFixed(2);
      const mins = Math.round(route.duration_s / 60);
      showRouteInfo(`Distance: ${km} km`);
      if (route.geometry && route.geometry.length) {
        await plotRouteOnMap(route.geometry);
        if (btnCreateRoom) btnCreateRoom.disabled = false;
      }
    } catch (err) {
      console.error('getRoute error', err);
      showRouteInfo('Network or server error while getting route.');
    } finally {
      if (btnGetRoute) btnGetRoute.disabled = false;
    }
  }

  async function reverseGeocode(lat, lon) {
    const res = await fetch(
      `${BACKEND_BASE}/api/navigation/reverse?lat=${lat}&lon=${lon}`,
      { credentials: "include" }
    );

    const data = await res.json();
    if (!data.success) throw new Error("Failed to reverse geocode");

    return data.address;
  }

  async function useMyLocation() {
    if (!navigator.geolocation) {
      showRouteInfo('Geolocation not supported by this browser.');
      return;
    }
    if (btnUseLocation) btnUseLocation.disabled = true;
    showRouteInfo('Getting current locationâ€¦');
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const addr = await reverseGeocode(lat, lon).catch(()=>`${lat.toFixed(5)}, ${lon.toFixed(5)}`);
      if (startInput) startInput.value = addr;
      showRouteInfo('Start set to your location. Now enter destination and click Get Route.');
      if (btnUseLocation) btnUseLocation.disabled = false;
    }, (err) => {
      console.warn('geolocation error', err);
      showRouteInfo('Could not get location: ' + (err.message || 'permission denied'));
      if (btnUseLocation) btnUseLocation.disabled = false;
    }, { enableHighAccuracy: false, timeout: 10000, maximumAge: 30000 });
  }

  async function checkSessionAndUpdateNav() {
    try {
      const res = await fetch(`${BACKEND_BASE}/auth/verify`, {
        method: 'GET',
        credentials: 'include',
        headers: { 'Accept': 'application/json' }
      });
      if (res.ok) {
        const user = await res.json();
        setLoggedInNav(user);
      } else {
      }
    } catch (err) {
      console.warn('session check error', err);
    }
  }

  function setLoggedInNav(user) {
    if (!navLinks) return;
    const loginA = navLinks.querySelector('a[href="walkingbuddy/login.html"]');
    const signupA = navLinks.querySelector('a[href="walkingbuddy/signup.html"]');

    try {
      if (loginA) loginA.remove();
      if (signupA) signupA.remove();
    } catch(e) {}

    const greet = document.createElement('span');
    greet.textContent = user.name ? `Hi, ${user.name}` : 'Hi';
    greet.style.marginLeft = '8px';
    greet.style.color = '#fff';
    greet.style.fontWeight = '600';

    const logoutA = document.createElement('a');
    logoutA.href = '#';
    logoutA.textContent = 'Logout';
    logoutA.className = 'auth-link';
    logoutA.style.marginLeft = '10px';
    logoutA.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await fetch(`${BACKEND_BASE}/auth/logout`, { method: 'POST', credentials: 'include' });
      } catch(err) { console.warn('logout error', err); }
      window.location.reload();
    });

    navLinks.appendChild(greet);
    navLinks.appendChild(logoutA);
  }

  async function createRoom() {
  if (!currentRouteData) {
    showRouteInfo("No route available to create a room. Load a route first.");
    return;
  }

  if (btnCreateRoom) {
    btnCreateRoom.disabled = true;
    btnCreateRoom.textContent = 'Creating room...';
  }

  try {
    const verifyRes = await fetch(`${BACKEND_BASE}/auth/verify`, {
      method: 'GET',
      credentials: 'include',
      headers: { 'Accept': 'application/json' }
    });

    if (!verifyRes.ok) {
      window.location.href = `${window.location.origin}/walkingbuddy/login.html`;
      return;
    }
    const user = await verifyRes.json();
    const userId = user.user_id || user.id || user.userId;
    if (!userId) {
      window.location.href = `${window.location.origin}/walkingbuddy/login.html`;
      return;
    }
    const start_coord = currentRouteData.start_coord && currentRouteData.start_coord.length === 2
      ? currentRouteData.start_coord
      : (currentRouteData.geometry && currentRouteData.geometry.length ? currentRouteData.geometry[0] : null);

    const dest_coord = currentRouteData.dest_coord && currentRouteData.dest_coord.length === 2
      ? currentRouteData.dest_coord
      : (currentRouteData.geometry && currentRouteData.geometry.length ? currentRouteData.geometry[currentRouteData.geometry.length - 1] : null);

    if (!start_coord || !dest_coord) {
      showRouteInfo("Could not determine start/destination coordinates for the room.");
      if (btnCreateRoom) { btnCreateRoom.disabled = false; btnCreateRoom.textContent = 'Create Room'; }
      return;
    }

    const payload = {
      user_id: String(userId),
      destination: currentRouteData.dest_text || '',
      start_coord: [Number(start_coord[0]), Number(start_coord[1])],
      dest_coord: [Number(dest_coord[0]), Number(dest_coord[1])],
      max_members: 10
    };

    const res = await fetch(`${BACKEND_BASE}/api/rooms/create`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    const data = await res.json().catch(()=>({}));

    if (res.ok && data.success) {
      const roomObj = data.room || {};
      const roomId = roomObj.id || roomObj.room_id || roomObj.roomId || roomObj['room_id'];
      const roomUrl = data.room_url || roomObj.url || roomObj.room_url;
      if (roomUrl) {
        window.location.href = roomUrl;
        return;
      } else if (roomId) {
        window.location.href = `${window.location.origin}/walkingbuddy/rooms.html?room_id=${encodeURIComponent(roomId)}`;
        return;
      } else {
        window.location.href = `${window.location.origin}/walkingbuddy/rooms.html`;
        return;
      }
    } else {
      const detail = data.detail || data.message || data.error || JSON.stringify(data) || res.statusText;
      showRouteInfo(`Failed to create room: ${detail}`);
    }
  } catch (err) {
    console.error('createRoom error', err);
    showRouteInfo('Network error while creating room.');
  } finally {
    if (btnCreateRoom) {
      btnCreateRoom.disabled = false;
      btnCreateRoom.textContent = 'Create Room';
    }
  }
}
  
document.addEventListener('DOMContentLoaded', () => {
  navLinks = document.querySelector('.nav-links');
  if (typeof removeAuthLinks === 'function') {
    removeAuthLinks();
  }
  if (typeof checkSessionAndUpdateNav === 'function') {
    checkSessionAndUpdateNav();
  }
});
  window.addEventListener('load', () => {
    btnGetRoute = document.getElementById('btn-get-route');
    btnUseLocation = document.getElementById('btn-use-location');
    btnCreateRoom = document.getElementById('btn-create-room');
    startInput = document.getElementById('start-input');
    destInput = document.getElementById('dest-input');
    routeInfo = document.getElementById('route-info');
    navLinks = document.querySelector('.nav-links');

    if (btnGetRoute) btnGetRoute.addEventListener('click', (e)=>{ e.preventDefault(); getRoute(); });
    if (btnUseLocation) btnUseLocation.addEventListener('click', (e)=>{ e.preventDefault(); useMyLocation(); });
    if (btnCreateRoom) btnCreateRoom.addEventListener('click', (e) => { e.preventDefault(); createRoom(); });

    if (destInput) {
      destInput.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') { ev.preventDefault(); getRoute(); }
      });
    }

    ensureMap();
    checkSessionAndUpdateNav();
  });
})();
</script>
<body>

  <header class="topbar">
    <div class="logo">Laurier Navigator</div>
    <nav class="nav-links">
      <a href="index.html" class="active">Navigation</a>
      <a href="rooms.html">Rooms</a>
      <a href="login.html">Login</a>
      <a href="signup.html">Sign Up</a>
    </nav>
  </header>

  <main class="layout">

    <section class="sidebar">

      <h1 class="section-title">Plan Your Route</h1>

      <label class="input-label">Start</label>
      <input id="start-input" class="text-input" placeholder="Enter start address" />

      <label class="input-label">Destination</label>
      <input id="dest-input" class="text-input" placeholder="Enter destination" />

      <div class="button-row">
        <button id="btn-get-route" class="btn primary">Get Route</button>
        <button id="btn-use-location" class="btn secondary">Use My Location</button>
      </div>

      <div id="route-info" class="info-box">
        <p>No route loaded.</p>
      </div>

      <hr class="divider" />

      <h2 class="section-title small">WalkingBuddy</h2>
      <p class="hint-text">Load a route to create a room.</p>

      <button id="btn-create-room" class="btn outline" disabled>Create Room</button>

    </section>

    <section class="map-area">
      <div id="map"></div>
    </section>

  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module" src="./modules/app.js"></script>

</body>
</html>
