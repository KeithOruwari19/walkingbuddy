<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rooms - Walking Buddy</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .msg-box {
      background:#141726;
      border-left:3px solid #3949ab;
      padding:10px 14px;
      border-radius:6px;
      margin-bottom:16px;
      display:none;
      color:#dfe2ff;
      font-size:14px;
    }
    .msg-box.error {
      border-color:#c62828;
      color:#ffd1d1;
    }
    .section-subtitle {
      font-size:16px;
      color:#bfc2e8;
      margin-top:30px;
      margin-bottom:10px;
      font-weight:600;
    }
  </style>
</head>
  <script src="./modules/auth.js"></script>
  <script type="module" src="./modules/app.js"></script>
<body>

<header class="topbar">
  <div class="logo">WalkingBuddy Rooms</div>
  <nav class="nav-links" id="nav-links">
    <a href="index.html">Navigation</a>
    <a href="rooms.html" class="active">Rooms</a>

    <span id="auth-links">
      <a href="login.html">Login</a>
      <a href="signup.html">Sign Up</a>
    </span>

    <span id="user-info" style="display:none; align-items:center; gap:10px;">
      <div id="user-avatar" style="
        width:32px;height:32px;border-radius:50%;
        display:flex;align-items:center;justify-content:center;
        font-size:14px;font-weight:600;color:#fff;
      "></div>
      <span id="user-name"></span>
      <a href="#" id="logout-btn" class="logout-link">Logout</a>
    </span>
  </nav>
</header>

<main class="rooms-container">

  <h1 class="section-title">Rooms</h1>

  <div id="message" class="msg-box"></div>

  <h2 class="section-subtitle">My Joined Rooms</h2>
  <div id="joined-rooms-list" class="room-list"></div>

  <h2 class="section-subtitle" style="margin-top:40px;">All Available Rooms</h2>
  <div id="no-rooms-message" class="no-rooms-message">
    <p>No rooms available. Create one!</p>
  </div>

  <div id="room-list" class="room-list"></div>

  <button id="toggle-create-room-form" class="btn primary-outline">Create New Room</button>

  <div id="create-room-form" class="create-room-form" style="display:none;">
    <h2>Create a New Room</h2>

    <label class="input-label">Room Name</label>
    <input id="room-name" class="text-input" placeholder="Enter room name" />

    <label class="input-label">Meet Time</label>
    <input id="meet-time" class="text-input" type="datetime-local" />

    <label class="input-label">Start Location</label>
    <input id="start-location" class="text-input" placeholder="Start location" />

    <label class="input-label">Destination</label>
    <input id="destination" class="text-input" placeholder="Destination" />

    <button id="btn-create-room" class="btn primary">Create Room</button>
  </div>

</main>

<script type="module" src="modules/auth.js"></script>

<script>
let rooms = JSON.parse(localStorage.getItem("rooms") || "[]");
let joinedRooms = JSON.parse(localStorage.getItem("joinedRooms") || "[]");

function showMessage(text, err=false) {
  const box = document.getElementById("message");
  box.textContent = text;
  box.className = err ? "msg-box error" : "msg-box";
  box.style.display = "block";
  setTimeout(() => box.style.display = "none", 2500);
}

function isValidMeetTime(raw) {
  if (!raw || !raw.includes("-")) return false;
  const year = raw.split("-")[0];
  if (!/^\d{4}$/.test(year)) return false;
  const d = new Date(raw);
  if (isNaN(d.getTime())) return false;
  const y = d.getFullYear();
  return y >= 2020 && y <= 2100;
}

function renderJoinedRooms() {
  const container = document.getElementById("joined-rooms-list");
  container.innerHTML = "";
  if (joinedRooms.length === 0) {
    container.innerHTML = `<p style="color:#777;font-size:14px;">You haven't joined any rooms yet.</p>`;
    return;
  }
  joinedRooms.forEach(roomName => {
    const room = rooms.find(r => r.name === roomName);
    if (!room) return;
    const div = document.createElement("div");
    div.classList.add("room-card");
    div.innerHTML = `
      <h3 class="room-title">${room.name}</h3>
      <div class="room-meta">
        <p><strong>Meeting:</strong> ${new Date(room.meetTime).toLocaleString()}</p>
      </div>
      <button class="btn secondary" onclick="enterRoom('${room.name}')">Enter Chat</button>
    `;
    container.appendChild(div);
  });
}

function renderRooms() {
  const list = document.getElementById("room-list");
  const empty = document.getElementById("no-rooms-message");
  if (rooms.length === 0) {
    empty.style.display = "block";
    list.innerHTML = "";
    return;
  }
  empty.style.display = "none";
  list.innerHTML = "";
  rooms.forEach(room => {
    const div = document.createElement("div");
    div.classList.add("room-card");
    div.innerHTML = `
      <h3 class="room-title">${room.name}</h3>
      <div class="room-meta">
        <p><strong>Members:</strong> ${room.members}</p>
        <p><strong>Meeting Time:</strong> ${new Date(room.meetTime).toLocaleString()}</p>
        <p><strong>Start Location:</strong> ${room.startLocation}</p>
        <p><strong>Destination:</strong> ${room.destination}</p>
      </div>
      <button class="btn secondary" onclick="joinRoom('${room.name}')">Join Room</button>
      <button class="btn outline" onclick="deleteRoom('${room.name}')">Delete Room</button>
    `;
    list.appendChild(div);
  });
}

document.getElementById("btn-create-room").addEventListener("click", () => {
  const name = document.getElementById("room-name").value.trim();
  const meet = document.getElementById("meet-time").value.trim();
  const start = document.getElementById("start-location").value.trim();
  const dest = document.getElementById("destination").value.trim();
  if (!name || !meet || !start || !dest) return showMessage("Fill in all fields.", true);
  if (!isValidMeetTime(meet)) return showMessage("Invalid date.", true);

  const newRoom = {
    id: Date.now(),
    name,
    meetTime: meet,
    startLocation: start,
    destination: dest,
    members: 1
  };
  rooms.push(newRoom);
  localStorage.setItem("rooms", JSON.stringify(rooms));
  document.getElementById("create-room-form").style.display = "none";
  renderJoinedRooms();
  renderRooms();
});

function joinRoom(roomName) {
  const room = rooms.find(r => r.name === roomName);
  if (!room) return;
  if (!joinedRooms.includes(roomName)) {
    joinedRooms.push(roomName);
    localStorage.setItem("joinedRooms", JSON.stringify(joinedRooms));
  }
  localStorage.setItem("currentRoom", JSON.stringify(room));
  window.location.href = "chat.html";
}

function enterRoom(roomName) {
  const room = rooms.find(r => r.name === roomName);
  if (!room) return;
  localStorage.setItem("currentRoom", JSON.stringify(room));
  window.location.href = "chat.html";
}

function deleteRoom(roomName) {
  rooms = rooms.filter(r => r.name !== roomName);
  joinedRooms = joinedRooms.filter(n => n !== roomName);
  localStorage.setItem("rooms", JSON.stringify(rooms));
  localStorage.setItem("joinedRooms", JSON.stringify(joinedRooms));
  renderJoinedRooms();
  renderRooms();
}

document.getElementById("toggle-create-room-form").addEventListener("click", () => {
  const form = document.getElementById("create-room-form");
  form.style.display = form.style.display === "none" ? "block" : "none";
});

renderJoinedRooms();
renderRooms();
</script>

</body>
</html>
