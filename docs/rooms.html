<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rooms - Walking Buddy</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .msg-box {
      background:#141726;
      border-left:3px solid #3949ab;
      padding:10px 14px;
      border-radius:6px;
      margin-bottom:16px;
      display:none;
      color:#dfe2ff;
      font-size:14px;
    }
    .msg-box.error { border-color:#c62828; color:#ffd1d1; }
    .section-subtitle {
      font-size:16px; color:#bfc2e8; margin-top:30px; margin-bottom:10px; font-weight:600;
    }

    #auth-links { display:inline-flex; gap:12px; align-items:center; }
    #user-info { display:inline-flex; gap:10px; align-items:center; }
    #user-avatar { width:32px; height:32px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:14px; font-weight:600; color:#fff; }

    /* === ADDED: styles for Leave Room button and actions container === */
    .btn.danger {
      background: #d9534f;
      color: #fff;
      border: 0;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    /* small helper so action buttons have spacing (if your stylesheet doesn't already provide it) */
    .room-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    /* ================================================================ */

  </style>
</head>

<body>
<header class="topbar">
  <div class="logo">WalkingBuddy Rooms</div>
  <nav class="nav-links" id="nav-links">
    <a href="index.html">Navigation</a>
    <a href="rooms.html" id="nav-rooms" class="active">Rooms</a>

    <span id="auth-links">
      <a href="login.html">Login</a>
      <a href="signup.html">Sign Up</a>
    </span>

    <span id="user-info" style="display:none;">
      <div id="user-avatar"></div>
      <span id="user-name"></span>
      <a href="#" id="logout-btn" class="logout-link">Logout</a>
    </span>
  </nav>
</header>

<main class="rooms-container">

  <h1 class="section-title">Rooms</h1>

  <div id="message" class="msg-box"></div>

  <h2 class="section-subtitle">My Joined Rooms</h2>
  <div id="joined-rooms-list" class="room-list"></div>

  <h2 class="section-subtitle" style="margin-top:40px;">All Available Rooms</h2>
  <div id="no-rooms-message" class="no-rooms-message">
    <p>No rooms available. Create one!</p>
  </div>

  <div id="room-list" class="room-list"></div>

  <button id="toggle-create-room-form" class="btn primary-outline">Create New Room</button>

  <div id="create-room-form" class="create-room-form" style="display:none;">
    <h2>Create a New Room</h2>

    <label class="input-label">Room Name</label>
    <input id="room-name" class="text-input" placeholder="Enter room name" />

    <label class="input-label">Meet Time</label>
    <input id="meet-time" class="text-input" type="datetime-local" />

    <label class="input-label">Start Location</label>
    <input id="start-location" class="text-input" placeholder="Start location" />

    <label class="input-label">Destination</label>
    <input id="destination" class="text-input" placeholder="Destination" />

    <button id="btn-create-room" class="btn primary">Create Room</button>
  </div>

</main>

<script>
(() => {
  const authLinks = document.getElementById('auth-links');
  const userInfo = document.getElementById('user-info');
  const userNameSpan = document.getElementById('user-name');
  const avatar = document.getElementById('user-avatar');
  const logoutBtn = document.getElementById('logout-btn');
  const roomsNav = document.getElementById('nav-rooms');

  function getStoredUser() {
    try { return JSON.parse(localStorage.getItem('user') || 'null'); }
    catch { return null; }
  }

  function initials(name, email){
    if(name){
      const parts = name.trim().split(/\s+/);
      if(parts.length === 1) return parts[0][0].toUpperCase();
      return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
    }
    return (email || '?')[0].toUpperCase();
  }

  function colorFromString(str){
    if(!str) return '#3949ab';
    let hash=0;
    for(let i=0;i<str.length;i++) hash = str.charCodeAt(i) + ((hash<<5)-hash);
    const hue = Math.abs(hash % 360);
    return `hsl(${hue},65%,55%)`;
  }

  function showProfile(user){
    if(authLinks){ authLinks.style.display = 'none'; authLinks.classList.add('hidden'); }
    if(userInfo){ userInfo.style.display = 'inline-flex'; userInfo.classList.remove('hidden'); }
    if(userNameSpan) userNameSpan.textContent = user.name || user.email || 'Hi';
    if(avatar){ avatar.textContent = initials(user.name, user.email); avatar.style.backgroundColor = colorFromString(user.email || user.name || ''); }
  }
  function showAnon(){
    if(authLinks){ authLinks.style.display = 'inline-flex'; authLinks.classList.remove('hidden'); }
    if(userInfo){ userInfo.style.display = 'none'; userInfo.classList.add('hidden'); }
    if(avatar) avatar.textContent = '';
    if(userNameSpan) userNameSpan.textContent = '';
  }

  window.addEventListener('auth:update', (e) => {
    const u = e && e.detail ? e.detail : getStoredUser();
    if (u) showProfile(u); else showAnon();
  });

  window.addEventListener('storage', (e) => {
    if (e.key === 'user') {
      try {
        const v = e.newValue ? JSON.parse(e.newValue) : null;
        if (v) showProfile(v); else showAnon();
      } catch { showAnon(); }
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    const cached = getStoredUser();
    if (cached) showProfile(cached);
    else {
      showAnon();
    }
  });

  if (logoutBtn) logoutBtn.addEventListener('click', async (ev) => {
    ev.preventDefault();
    try {
      await fetch('/auth/logout', { method: 'POST', credentials: 'include' }).catch(()=>{});
    } catch {}
    try { localStorage.removeItem('user'); } catch {}
    window.dispatchEvent(new CustomEvent('auth:update', { detail: null }));
  });
  
  if (roomsNav) roomsNav.addEventListener('click', (ev) => {
    const u = getStoredUser();
    if (!u) {
      ev.preventDefault();
      window.location.href = 'login.html';
    }
  });
})();
</script>

<script>
(function () {
  const params = new URLSearchParams(window.location.search);
  const start = params.get('start');
  const dest = params.get('dest');

  if (!start && !dest) return;

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('create-room-form');
    const startInput = document.getElementById('start-location');
    const destInput = document.getElementById('destination');
    const roomName = document.getElementById('room-name');

    if (form) form.style.display = 'block';
    if (startInput && start) startInput.value = start;
    if (destInput && dest) destInput.value = dest;
    if (roomName && dest) {
      try { roomName.value = `Walk to ${dest.split(',')[0].trim()}`; } catch {}
    }
    if (form) form.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });
})();
</script>

<script type="module" src="/walkingbuddy/modules/rooms.js"></script>

</body>
</html>
