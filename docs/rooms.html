<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rooms - Walking Buddy</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .msg-box {
      background:#141726;
      border-left:3px solid #3949ab;
      padding:10px 14px;
      border-radius:6px;
      margin-bottom:16px;
      display:none;
      color:#dfe2ff;
      font-size:14px;
    }
    .msg-box.error {
      border-color:#c62828;
      color:#ffd1d1;
    }
    .section-subtitle {
      font-size:16px;
      color:#bfc2e8;
      margin-top:30px;
      margin-bottom:10px;
      font-weight:600;
    }
  </style>
</head>
  <script src="./modules/auth.js"></script>
  <script type="module" src="./modules/app.js"></script>
<body>

<header class="topbar">
  <div class="logo">WalkingBuddy Rooms</div>
  <nav class="nav-links" id="nav-links">
    <a href="index.html">Navigation</a>
    <a href="rooms.html" class="active">Rooms</a>

    <span id="auth-links">
      <a href="login.html">Login</a>
      <a href="signup.html">Sign Up</a>
    </span>

    <span id="user-info" style="display:none; align-items:center; gap:10px;">
      <div id="user-avatar" style="
        width:32px;height:32px;border-radius:50%;
        display:flex;align-items:center;justify-content:center;
        font-size:14px;font-weight:600;color:#fff;
      "></div>
      <span id="user-name"></span>
      <a href="#" id="logout-btn" class="logout-link">Logout</a>
    </span>
  </nav>
</header>

<main class="rooms-container">

  <h1 class="section-title">Rooms</h1>

  <div id="message" class="msg-box"></div>

  <h2 class="section-subtitle">My Joined Rooms</h2>
  <div id="joined-rooms-list" class="room-list"></div>

  <h2 class="section-subtitle" style="margin-top:40px;">All Available Rooms</h2>
  <div id="no-rooms-message" class="no-rooms-message">
    <p>No rooms available. Create one!</p>
  </div>

  <div id="room-list" class="room-list"></div>

  <button id="toggle-create-room-form" class="btn primary-outline">Create New Room</button>

  <div id="create-room-form" class="create-room-form" style="display:none;">
    <h2>Create a New Room</h2>

    <label class="input-label">Room Name</label>
    <input id="room-name" class="text-input" placeholder="Enter room name" />

    <label class="input-label">Meet Time</label>
    <input id="meet-time" class="text-input" type="datetime-local" />

    <label class="input-label">Start Location</label>
    <input id="start-location" class="text-input" placeholder="Start location" />

    <label class="input-label">Destination</label>
    <input id="destination" class="text-input" placeholder="Destination" />

    <button id="btn-create-room" class="btn primary">Create Room</button>
  </div>

</main>
<script>
(function(){
  const API_JOIN = '/api/rooms/join';

  function getUserId() {
    try {
      const u = JSON.parse(localStorage.getItem('user') || 'null');
      return u?.id || u?.user_id || u?.email || u?.name || `guest-${Math.floor(Math.random()*100000)}`;
    } catch { return `guest-${Math.floor(Math.random()*100000)}`; }
  }

  function extractRoomFromCard(cardEl) {
    if (!cardEl) return null;
    const title = cardEl.querySelector('.room-title')?.textContent?.trim() || '';
    const membersText = cardEl.querySelector('.room-meta p strong')?.parentElement?.textContent || '';
    const meetP = Array.from(cardEl.querySelectorAll('.room-meta p')).find(p => /meeting|meet/i.test(p.textContent));
    const startP = Array.from(cardEl.querySelectorAll('.room-meta p')).find(p => /start/i.test(p.textContent));
    const destP = Array.from(cardEl.querySelectorAll('.room-meta p')).find(p => /destination/i.test(p.textContent));
    return {
      id: cardEl.dataset.roomId || cardEl.dataset.id || title,
      name: title,
      members: parseInt((membersText.match(/\d+/)||['0'])[0],10) || 0,
      meetTime: meetP ? meetP.textContent.replace(/Meeting:|Meeting Time:/i,'').trim() : null,
      startLocation: startP ? startP.textContent.replace(/Start Location:/i,'').trim() : '',
      destination: destP ? destP.textContent.replace(/Destination:/i,'').trim() : ''
    };
  }

  async function serverJoin(roomIdOrName) {
    const payload = { room_id: roomIdOrName, user_id: getUserId() };
    try {
      const res = await fetch(API_JOIN, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      let j = null;
      try { j = JSON.parse(text); } catch {}
      if (!res.ok) {
        console.warn('join failed', res.status, text);
        return j?.room || null;
      }
      return j?.room || j || null;
    } catch (e) {
      console.warn('join network failed', e);
      return null;
    }
  }

  async function doJoinAndEnter(cardEl, navigate = false) {
    const room = extractRoomFromCard(cardEl);
    if (!room) { console.warn('no room element'); return; }

    let serverRoom = null;
    if (room.id) {
      serverRoom = await serverJoin(room.id);
    }

    const toStore = serverRoom || room;
    try { localStorage.setItem('currentRoom', JSON.stringify(toStore)); } catch (e) { console.warn('store failed', e); }

    try {
      const joined = JSON.parse(localStorage.getItem('joinedRooms') || '[]');
      if (!joined.includes(toStore.id || toStore.name)) {
        joined.push(toStore.id || toStore.name);
        localStorage.setItem('joinedRooms', JSON.stringify(joined));
      }
    } catch (e) {}

    if (navigate) window.location.href = 'chat.html';
  }

  document.addEventListener('click', async (ev) => {
    const t = ev.target;

    const joinId = t?.dataset?.join;
    const enterId = t?.dataset?.enter;
    if (joinId) {
      ev.preventDefault();
      const card = t.closest('.room-card') || document.querySelector(`.room-card[data-room-id="${joinId}"]`);
      await doJoinAndEnter(card, true);
      return;
    }
    if (enterId) {
      ev.preventDefault();
      const card = t.closest('.room-card') || document.querySelector(`.room-card[data-room-id="${enterId}"]`);
      const room = extractRoomFromCard(card);
      if (room) {
        localStorage.setItem('currentRoom', JSON.stringify(room));
        const joined = JSON.parse(localStorage.getItem('joinedRooms') || '[]');
        if (!joined.includes(room.id || room.name)) {
          joined.push(room.id || room.name);
          localStorage.setItem('joinedRooms', JSON.stringify(joined));
        }
      }
      window.location.href = 'chat.html';
      return;
    }

    if (t.tagName === 'BUTTON' || t.tagName === 'A') {
      const onclick = t.getAttribute && t.getAttribute('onclick');
      if (onclick && /joinRoom\(['"](.+?)['"]\)/.test(onclick)) {
        ev.preventDefault();
        const name = onclick.match(/joinRoom\(['"](.+?)['"]\)/)[1];
        const card = Array.from(document.querySelectorAll('.room-card')).find(c => (c.querySelector('.room-title')?.textContent||'').trim() === name);
        await doJoinAndEnter(card, true);
        return;
      }
      if (onclick && /enterRoom\(['"](.+?)['"]\)/.test(onclick)) {
        ev.preventDefault();
        const name = onclick.match(/enterRoom\(['"](.+?)['"]\)/)[1];
        const card = Array.from(document.querySelectorAll('.room-card')).find(c => (c.querySelector('.room-title')?.textContent||'').trim() === name);
        if (card) {
          const room = extractRoomFromCard(card);
          localStorage.setItem('currentRoom', JSON.stringify(room));
          const joined = JSON.parse(localStorage.getItem('joinedRooms') || '[]');
          if (!joined.includes(room.id || room.name)) {
            joined.push(room.id || room.name);
            localStorage.setItem('joinedRooms', JSON.stringify(joined));
          }
        }
        window.location.href = 'chat.html';
        return;
      }
    }
  }, { capture: false });
})();
</script>
<script type="module" src="/walkingbuddy/modules/rooms.js"></script>
  
</body>
</html>
